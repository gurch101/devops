---
- name: Create droplets
  digital_ocean:
    state: present
    command: droplet
    name: "{{ item.name }}"
    size_id: "{{ item.size | default('512mb') }}"
    image_id: "{{ item.image | default('ubuntu-16-04-x64') }}"
    region_id: "{{ item.region | default('sfo1') }}"
    unique_name: yes
    ssh_key_ids: "{{ item.ssh_key_ids }}"
    wait: true
  register: do_response
  with_items: "{{ droplets }}"
  loop_control:
    label: "{{ do_response.droplet.ip_address }}"

- name: Add hosts to inventory
  add_host:
    name: "{{ item.1.droplet.ip_address }}"
    groups: "do,nodes,{{ droplets[item.0].group }},{{ item.1.changed | ternary(',new-nodes', '') }}"
  with_indexed_items: "{{ do_response.results }}"
  loop_control:
    label: "{{ item.1.droplet.ip_address }}"
